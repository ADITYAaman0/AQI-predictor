# Complete Step-by-Step Implementation Guide
## Leaflet.js + OpenFreeMap for Delhi-NCR AQI Forecasting Platform

---

## üìã Table of Contents

1. [Project Setup](#step-1-project-setup)
2. [Create Basic Map](#step-2-create-basic-map)
3. [Add AQI Monitoring Stations](#step-3-add-aqi-monitoring-stations)
4. [Create Heatmap Layer](#step-4-create-heatmap-layer)
5. [Add Interactive Features](#step-5-add-interactive-features)
6. [Implement 24-Hour Forecast Animation](#step-6-implement-forecast-animation)
7. [Add Source Attribution Visualization](#step-7-add-source-attribution)
8. [Connect to Backend API](#step-8-connect-to-backend-api)
9. [Mobile Optimization](#step-9-mobile-optimization)
10. [Testing & Deployment](#step-10-testing-deployment)

---

## STEP 1: Project Setup

### 1.1 Create Project Directory Structure

Open your terminal and run:

```bash
# Create project directory
mkdir aqi-forecasting-platform
cd aqi-forecasting-platform

# Create subdirectories
mkdir -p frontend/{css,js,assets/icons}
mkdir -p backend/api
mkdir -p data

# Your structure should look like:
# aqi-forecasting-platform/
# ‚îú‚îÄ‚îÄ frontend/
# ‚îÇ   ‚îú‚îÄ‚îÄ index.html
# ‚îÇ   ‚îú‚îÄ‚îÄ css/
# ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ styles.css
# ‚îÇ   ‚îú‚îÄ‚îÄ js/
# ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ map.js
# ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data-loader.js
# ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layers.js
# ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.js
# ‚îÇ   ‚îî‚îÄ‚îÄ assets/
# ‚îÇ       ‚îî‚îÄ‚îÄ icons/
# ‚îú‚îÄ‚îÄ backend/
# ‚îÇ   ‚îî‚îÄ‚îÄ api/
# ‚îî‚îÄ‚îÄ data/
```

### 1.2 Create index.html

Create `frontend/index.html`:

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Real-time Air Quality Index forecasting for Delhi-NCR">
    <title>Delhi-NCR AQI Forecasting Platform</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet.heat Plugin for Heatmap -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <!-- Leaflet.markercluster Plugin for Clustering -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Your Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="spinner-overlay">
        <div class="spinner"></div>
        <p>Loading AQI data...</p>
    </div>
    
    <!-- Map Container -->
    <div id="map"></div>
    
    <!-- Header Panel -->
    <div class="header-panel">
        <h1>üåç Delhi-NCR Air Quality</h1>
        <p id="last-updated">Loading...</p>
    </div>
    
    <!-- Control Panel -->
    <div class="control-panel">
        <h3>Controls</h3>
        
        <!-- View Toggle -->
        <div class="control-group">
            <label>View Mode:</label>
            <div class="button-group">
                <button id="btn-current" class="btn-toggle active">Current</button>
                <button id="btn-forecast" class="btn-toggle">Forecast</button>
            </div>
        </div>
        
        <!-- Layer Toggle -->
        <div class="control-group">
            <label>Visualization:</label>
            <div class="button-group">
                <button id="btn-markers" class="btn-toggle active">Markers</button>
                <button id="btn-heatmap" class="btn-toggle">Heatmap</button>
            </div>
        </div>
        
        <!-- District Filter -->
        <div class="control-group">
            <label for="district-filter">Filter by District:</label>
            <select id="district-filter">
                <option value="all">All Districts</option>
                <option value="Central Delhi">Central Delhi</option>
                <option value="North Delhi">North Delhi</option>
                <option value="South Delhi">South Delhi</option>
                <option value="East Delhi">East Delhi</option>
                <option value="West Delhi">West Delhi</option>
                <option value="New Delhi">New Delhi</option>
                <option value="Noida">Noida</option>
                <option value="Ghaziabad">Ghaziabad</option>
                <option value="Gurgaon">Gurgaon</option>
                <option value="Faridabad">Faridabad</option>
            </select>
        </div>
    </div>
    
    <!-- Forecast Animation Controls -->
    <div id="forecast-controls" class="forecast-controls" style="display: none;">
        <h4>24-Hour Forecast</h4>
        <div class="timeline-controls">
            <button id="btn-play">‚ñ∂ Play</button>
            <button id="btn-pause" disabled>‚è∏ Pause</button>
            <button id="btn-reset">‚Ü∫ Reset</button>
        </div>
        <div class="slider-container">
            <input type="range" id="hour-slider" min="0" max="24" value="0" step="1">
            <div class="slider-labels">
                <span>Now</span>
                <span id="current-hour-label">+0h</span>
                <span>+24h</span>
            </div>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="legend">
        <h4>AQI Categories</h4>
        <div class="legend-items">
            <div class="legend-item">
                <div class="legend-color" style="background: #00E400;"></div>
                <span class="legend-text">Good (0-50)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFFF00;"></div>
                <span class="legend-text">Moderate (51-100)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF7E00;"></div>
                <span class="legend-text">Unhealthy for Sensitive (101-150)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF0000;"></div>
                <span class="legend-text">Unhealthy (151-200)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #8F3F97;"></div>
                <span class="legend-text">Very Unhealthy (201-300)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #7E0023;"></div>
                <span class="legend-text">Hazardous (301+)</span>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Your JavaScript Files -->
    <script src="js/utils.js"></script>
    <script src="js/data-loader.js"></script>
    <script src="js/layers.js"></script>
    <script src="js/map.js"></script>
</body>
</html>
```

### 1.3 Create styles.css

Create `frontend/css/styles.css`:

```css
/* Reset and Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    overflow: hidden;
}

/* Map Container */
#map {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 0;
}

/* Loading Spinner */
.spinner-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.spinner-overlay p {
    color: white;
    margin-top: 20px;
    font-size: 16px;
}

/* Header Panel */
.header-panel {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-width: 350px;
}

.header-panel h1 {
    font-size: 20px;
    margin-bottom: 8px;
    color: #2c3e50;
}

.header-panel p {
    font-size: 13px;
    color: #7f8c8d;
}

/* Control Panel */
.control-panel {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    min-width: 280px;
}

.control-panel h3 {
    font-size: 18px;
    margin-bottom: 15px;
    color: #2c3e50;
    border-bottom: 2px solid #3498db;
    padding-bottom: 8px;
}

.control-group {
    margin-bottom: 15px;
}

.control-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: #34495e;
    margin-bottom: 8px;
}

.button-group {
    display: flex;
    gap: 5px;
}

.btn-toggle {
    flex: 1;
    padding: 8px 12px;
    border: 2px solid #bdc3c7;
    background: white;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-toggle:hover {
    background: #ecf0f1;
}

.btn-toggle.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

#district-filter {
    width: 100%;
    padding: 8px;
    border: 2px solid #bdc3c7;
    border-radius: 5px;
    font-size: 13px;
    background: white;
    cursor: pointer;
}

/* Forecast Controls */
.forecast-controls {
    position: absolute;
    bottom: 120px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    min-width: 400px;
}

.forecast-controls h4 {
    font-size: 16px;
    margin-bottom: 12px;
    color: #2c3e50;
    text-align: center;
}

.timeline-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    justify-content: center;
}

.timeline-controls button {
    padding: 8px 16px;
    border: 2px solid #3498db;
    background: white;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.timeline-controls button:hover:not(:disabled) {
    background: #3498db;
    color: white;
}

.timeline-controls button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.slider-container {
    position: relative;
}

#hour-slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
    background: linear-gradient(to right, #3498db 0%, #e74c3c 100%);
}

#hour-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #2c3e50;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

#hour-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #2c3e50;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.slider-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 12px;
    color: #7f8c8d;
}

#current-hour-label {
    font-weight: 600;
    color: #2c3e50;
}

/* Legend */
.legend {
    position: absolute;
    bottom: 30px;
    right: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    min-width: 250px;
}

.legend h4 {
    font-size: 14px;
    margin-bottom: 10px;
    color: #2c3e50;
    border-bottom: 2px solid #3498db;
    padding-bottom: 5px;
}

.legend-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.legend-color {
    width: 25px;
    height: 25px;
    border-radius: 4px;
    border: 2px solid #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.legend-text {
    font-size: 12px;
    color: #34495e;
    font-weight: 500;
}

/* Custom Popup Styles */
.leaflet-popup-content-wrapper {
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.leaflet-popup-content {
    margin: 15px;
    font-family: inherit;
}

.popup-header {
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 2px solid #ecf0f1;
}

.popup-header h3 {
    font-size: 16px;
    color: #2c3e50;
    margin-bottom: 4px;
}

.popup-header .station-id {
    font-size: 11px;
    color: #95a5a6;
}

.aqi-badge {
    text-align: center;
    padding: 12px;
    border-radius: 6px;
    margin: 12px 0;
    color: white;
    font-weight: bold;
}

.aqi-value {
    font-size: 28px;
    display: block;
}

.aqi-category {
    font-size: 13px;
    display: block;
    margin-top: 4px;
}

.popup-data {
    margin: 12px 0;
}

.data-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    font-size: 13px;
    border-bottom: 1px solid #ecf0f1;
}

.data-row:last-child {
    border-bottom: none;
}

.data-label {
    font-weight: 600;
    color: #7f8c8d;
}

.data-value {
    color: #2c3e50;
}

.forecast-section {
    margin-top: 15px;
    padding-top: 12px;
    border-top: 2px solid #ecf0f1;
}

.forecast-section h4 {
    font-size: 14px;
    color: #2c3e50;
    margin-bottom: 8px;
}

.source-attribution {
    margin-top: 15px;
}

.source-bar {
    height: 25px;
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    margin: 8px 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.source-segment {
    height: 100%;
    transition: width 0.3s ease;
}

.source-legend {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    font-size: 11px;
    margin-top: 8px;
}

.source-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.source-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.timestamp {
    font-size: 11px;
    color: #95a5a6;
    margin-top: 10px;
    text-align: center;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .header-panel {
        top: 10px;
        left: 10px;
        right: 10px;
        max-width: none;
        padding: 12px 15px;
    }
    
    .header-panel h1 {
        font-size: 16px;
    }
    
    .control-panel {
        top: auto;
        bottom: 10px;
        right: 10px;
        left: 10px;
        min-width: auto;
        max-height: 40vh;
        overflow-y: auto;
    }
    
    .legend {
        bottom: auto;
        top: 80px;
        right: 10px;
        min-width: 200px;
    }
    
    .forecast-controls {
        min-width: auto;
        left: 10px;
        right: 10px;
        transform: none;
        bottom: 10px;
    }
}

@media (max-width: 480px) {
    .button-group {
        flex-direction: column;
    }
    
    .btn-toggle {
        width: 100%;
    }
}
```

---

## STEP 2: Create Basic Map

### 2.1 Create utils.js

Create `frontend/js/utils.js`:

```javascript
// Utility functions for the AQI application

/**
 * Get AQI color based on value
 * @param {number} aqi - AQI value
 * @returns {string} - Hex color code
 */
function getAQIColor(aqi) {
    if (aqi <= 50) return '#00E400';        // Good
    if (aqi <= 100) return '#FFFF00';       // Moderate
    if (aqi <= 150) return '#FF7E00';       // Unhealthy for Sensitive
    if (aqi <= 200) return '#FF0000';       // Unhealthy
    if (aqi <= 300) return '#8F3F97';       // Very Unhealthy
    return '#7E0023';                       // Hazardous
}

/**
 * Get AQI category name
 * @param {number} aqi - AQI value
 * @returns {string} - Category name
 */
function getAQICategory(aqi) {
    if (aqi <= 50) return 'Good';
    if (aqi <= 100) return 'Moderate';
    if (aqi <= 150) return 'Unhealthy for Sensitive Groups';
    if (aqi <= 200) return 'Unhealthy';
    if (aqi <= 300) return 'Very Unhealthy';
    return 'Hazardous';
}

/**
 * Get health message based on AQI
 * @param {number} aqi - AQI value
 * @returns {string} - Health message
 */
function getHealthMessage(aqi) {
    if (aqi <= 50) return 'Air quality is satisfactory, and air pollution poses little or no risk.';
    if (aqi <= 100) return 'Air quality is acceptable. However, there may be a risk for some people.';
    if (aqi <= 150) return 'Members of sensitive groups may experience health effects.';
    if (aqi <= 200) return 'Everyone may begin to experience health effects.';
    if (aqi <= 300) return 'Health alert: The risk of health effects is increased for everyone.';
    return 'Health warning of emergency conditions: everyone is more likely to be affected.';
}

/**
 * Format timestamp to readable format
 * @param {string} timestamp - ISO timestamp
 * @returns {string} - Formatted date/time
 */
function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

/**
 * Show loading spinner
 */
function showLoading() {
    const spinner = document.getElementById('loading-spinner');
    if (spinner) spinner.style.display = 'flex';
}

/**
 * Hide loading spinner
 */
function hideLoading() {
    const spinner = document.getElementById('loading-spinner');
    if (spinner) spinner.style.display = 'none';
}

/**
 * Show error message
 * @param {string} message - Error message to display
 */
function showError(message) {
    alert('Error: ' + message);
    console.error('Application Error:', message);
}

/**
 * Debounce function for performance optimization
 * @param {Function} func - Function to debounce
 * @param {number} wait - Wait time in milliseconds
 * @returns {Function} - Debounced function
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
```

### 2.2 Create map.js

Create `frontend/js/map.js`:

```javascript
// Main map initialization and control logic

let map;
let currentLayer = null;
let heatmapLayer = null;
let markerLayer = null;
let animationInterval = null;
let currentHour = 0;

/**
 * Initialize the map
 */
function initMap() {
    // Create map instance centered on Delhi-NCR
    map = L.map('map', {
        center: [28.6139, 77.2090],
        zoom: 10,
        minZoom: 8,
        maxZoom: 18,
        zoomControl: false  // We'll add it in a custom position
    });
    
    // Add OpenFreeMap tiles (FREE!)
    L.tileLayer('https://tiles.openfreemap.org/styles/liberty/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://openfreemap.org">OpenFreeMap</a> ¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
    }).addTo(map);
    
    // Add zoom control to top-left
    L.control.zoom({
        position: 'topleft'
    }).addTo(map);
    
    // Add scale control
    L.control.scale({
        position: 'bottomleft',
        imperial: false
    }).addTo(map);
    
    // Initialize marker cluster group
    markerLayer = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });
    
    // Initialize layers
    initializeLayers();
    
    // Setup event listeners
    setupEventListeners();
    
    // Load initial data
    loadCurrentData();
    
    console.log('Map initialized successfully');
}

/**
 * Initialize data layers
 */
function initializeLayers() {
    // Marker layer is already created as cluster group
    map.addLayer(markerLayer);
    currentLayer = 'markers';
}

/**
 * Setup all event listeners
 */
function setupEventListeners() {
    // View mode toggle
    document.getElementById('btn-current').addEventListener('click', () => {
        switchView('current');
    });
    
    document.getElementById('btn-forecast').addEventListener('click', () => {
        switchView('forecast');
    });
    
    // Visualization toggle
    document.getElementById('btn-markers').addEventListener('click', () => {
        switchVisualization('markers');
    });
    
    document.getElementById('btn-heatmap').addEventListener('click', () => {
        switchVisualization('heatmap');
    });
    
    // District filter
    document.getElementById('district-filter').addEventListener('change', (e) => {
        filterByDistrict(e.target.value);
    });
    
    // Forecast controls
    document.getElementById('btn-play').addEventListener('click', startAnimation);
    document.getElementById('btn-pause').addEventListener('click', pauseAnimation);
    document.getElementById('btn-reset').addEventListener('click', resetAnimation);
    document.getElementById('hour-slider').addEventListener('input', (e) => {
        updateForecastHour(parseInt(e.target.value));
    });
}

/**
 * Switch between current and forecast view
 * @param {string} view - 'current' or 'forecast'
 */
function switchView(view) {
    // Update button states
    document.getElementById('btn-current').classList.toggle('active', view === 'current');
    document.getElementById('btn-forecast').classList.toggle('active', view === 'forecast');
    
    // Show/hide forecast controls
    const forecastControls = document.getElementById('forecast-controls');
    if (view === 'forecast') {
        forecastControls.style.display = 'block';
        loadForecastData(currentHour);
    } else {
        forecastControls.style.display = 'none';
        stopAnimation();
        loadCurrentData();
    }
}

/**
 * Switch between markers and heatmap visualization
 * @param {string} viz - 'markers' or 'heatmap'
 */
function switchVisualization(viz) {
    // Update button states
    document.getElementById('btn-markers').classList.toggle('active', viz === 'markers');
    document.getElementById('btn-heatmap').classList.toggle('active', viz === 'heatmap');
    
    if (viz === 'markers') {
        if (heatmapLayer) map.removeLayer(heatmapLayer);
        if (markerLayer) map.addLayer(markerLayer);
        currentLayer = 'markers';
    } else {
        if (markerLayer) map.removeLayer(markerLayer);
        // Heatmap will be created when data is loaded
        currentLayer = 'heatmap';
        // Reload data to create heatmap
        const forecastView = document.getElementById('btn-forecast').classList.contains('active');
        if (forecastView) {
            loadForecastData(currentHour);
        } else {
            loadCurrentData();
        }
    }
}

/**
 * Filter markers by district
 * @param {string} district - District name or 'all'
 */
function filterByDistrict(district) {
    // This will be implemented with actual data
    console.log('Filtering by district:', district);
    loadCurrentData(district);
}

/**
 * Load current AQI data
 * @param {string} district - Optional district filter
 */
async function loadCurrentData(district = 'all') {
    showLoading();
    
    try {
        const data = await DataLoader.fetchCurrentAQI(district);
        
        if (currentLayer === 'markers') {
            LayerManager.updateMarkerLayer(markerLayer, data);
        } else {
            if (heatmapLayer) map.removeLayer(heatmapLayer);
            heatmapLayer = LayerManager.createHeatmapLayer(data);
            map.addLayer(heatmapLayer);
        }
        
        // Update timestamp
        document.getElementById('last-updated').textContent = 
            'Last updated: ' + formatTimestamp(new Date().toISOString());
        
    } catch (error) {
        showError('Failed to load AQI data: ' + error.message);
    } finally {
        hideLoading();
    }
}

/**
 * Load forecast data for specific hour
 * @param {number} hour - Hour offset (0-24)
 */
async function loadForecastData(hour) {
    showLoading();
    
    try {
        const data = await DataLoader.fetchForecast(hour);
        
        if (currentLayer === 'markers') {
            LayerManager.updateMarkerLayer(markerLayer, data);
        } else {
            if (heatmapLayer) map.removeLayer(heatmapLayer);
            heatmapLayer = LayerManager.createHeatmapLayer(data);
            map.addLayer(heatmapLayer);
        }
        
        // Update hour label
        document.getElementById('current-hour-label').textContent = `+${hour}h`;
        
    } catch (error) {
        showError('Failed to load forecast data: ' + error.message);
    } finally {
        hideLoading();
    }
}

/**
 * Update forecast to specific hour
 * @param {number} hour - Hour offset (0-24)
 */
function updateForecastHour(hour) {
    currentHour = hour;
    loadForecastData(hour);
}

/**
 * Start forecast animation
 */
function startAnimation() {
    if (animationInterval) return;
    
    document.getElementById('btn-play').disabled = true;
    document.getElementById('btn-pause').disabled = false;
    
    animationInterval = setInterval(() => {
        currentHour = (currentHour + 1) % 25;
        document.getElementById('hour-slider').value = currentHour;
        updateForecastHour(currentHour);
    }, 1500); // Update every 1.5 seconds
}

/**
 * Pause forecast animation
 */
function pauseAnimation() {
    stopAnimation();
}

/**
 * Stop forecast animation
 */
function stopAnimation() {
    if (animationInterval) {
        clearInterval(animationInterval);
        animationInterval = null;
    }
    
    document.getElementById('btn-play').disabled = false;
    document.getElementById('btn-pause').disabled = true;
}

/**
 * Reset forecast animation
 */
function resetAnimation() {
    stopAnimation();
    currentHour = 0;
    document.getElementById('hour-slider').value = 0;
    updateForecastHour(0);
}

// Initialize map when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    initMap();
});
```

---

## STEP 3: Add AQI Monitoring Stations

### 3.1 Create data-loader.js

Create `frontend/js/data-loader.js`:

```javascript
// Data loading and API communication module

const DataLoader = {
    // API base URL - change this to your backend URL
    API_BASE_URL: '/api/v1',
    
    // For development/testing, we'll use sample data
    USE_SAMPLE_DATA: true,
    
    /**
     * Fetch current AQI data
     * @param {string} district - Optional district filter
     * @returns {Object} GeoJSON feature collection
     */
    async fetchCurrentAQI(district = 'all') {
        if (this.USE_SAMPLE_DATA) {
            return this.getSampleCurrentData(district);
        }
        
        try {
            const url = district === 'all' 
                ? `${this.API_BASE_URL}/predictions/current`
                : `${this.API_BASE_URL}/predictions/current?district=${district}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error('Error fetching current AQI:', error);
            throw error;
        }
    },
    
    /**
     * Fetch forecast data
     * @param {number} hour - Hour offset (0-24)
     * @returns {Object} GeoJSON feature collection
     */
    async fetchForecast(hour) {
        if (this.USE_SAMPLE_DATA) {
            return this.getSampleForecastData(hour);
        }
        
        try {
            const response = await fetch(`${this.API_BASE_URL}/predictions/forecast?hour=${hour}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error('Error fetching forecast:', error);
            throw error;
        }
    },
    
    /**
     * Fetch grid data for heatmap
     * @returns {Object} GeoJSON feature collection
     */
    async fetchGridData() {
        if (this.USE_SAMPLE_DATA) {
            return this.getSampleGridData();
        }
        
        try {
            const response = await fetch(`${this.API_BASE_URL}/predictions/grid`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error('Error fetching grid data:', error);
            throw error;
        }
    },
    
    /**
     * Generate sample current AQI data for testing
     * @param {string} district - District filter
     * @returns {Object} Sample GeoJSON
     */
    getSampleCurrentData(district) {
        const allStations = [
            {
                coords: [77.2090, 28.6139],
                name: "Anand Vihar",
                district: "East Delhi",
                aqi: 285,
                pm25: 165.5,
                pm10: 280.3,
                no2: 45.2,
                category: "Very Unhealthy",
                sources: { vehicular: 45, industrial: 20, biomass: 25, background: 10 }
            },
            {
                coords: [77.1025, 28.7041],
                name: "Rohini",
                district: "North Delhi",
                aqi: 195,
                pm25: 110.8,
                pm10: 195.5,
                no2: 38.5,
                category: "Unhealthy",
                sources: { vehicular: 50, industrial: 15, biomass: 20, background: 15 }
            },
            {
                coords: [77.3910, 28.5355],
                name: "Noida Sector 62",
                district: "Noida",
                aqi: 310,
                pm25: 185.2,
                pm10: 310.7,
                no2: 52.3,
                category: "Hazardous",
                sources: { vehicular: 40, industrial: 35, biomass: 15, background: 10 }
            },
            {
                coords: [77.0266, 28.4595],
                name: "Gurgaon City Center",
                district: "Gurgaon",
                aqi: 225,
                pm25: 135.6,
                pm10: 225.4,
                no2: 42.1,
                category: "Very Unhealthy",
                sources: { vehicular: 55, industrial: 25, biomass: 10, background: 10 }
            },
            {
                coords: [77.2088, 28.5672],
                name: "ITO",
                district: "Central Delhi",
                aqi: 265,
                pm25: 155.3,
                pm10: 265.8,
                no2: 48.7,
                category: "Very Unhealthy",
                sources: { vehicular: 60, industrial: 15, biomass: 15, background: 10 }
            },
            {
                coords: [77.1734, 28.6692],
                name: "DTU",
                district: "North Delhi",
                aqi: 180,
                pm25: 98.5,
                pm10: 180.2,
                no2: 35.6,
                category: "Unhealthy",
                sources: { vehicular: 45, industrial: 20, biomass: 20, background: 15 }
            },
            {
                coords: [77.2167, 28.4817],
                name: "Okhla Phase 2",
                district: "South Delhi",
                aqi: 245,
                pm25: 145.7,
                pm10: 245.3,
                no2: 44.8,
                category: "Very Unhealthy",
                sources: { vehicular: 40, industrial: 40, biomass: 10, background: 10 }
            },
            {
                coords: [77.1115, 28.6515],
                name: "Punjabi Bagh",
                district: "West Delhi",
                aqi: 210,
                pm25: 120.4,
                pm10: 210.6,
                no2: 40.2,
                category: "Very Unhealthy",
                sources: { vehicular: 50, industrial: 20, biomass: 20, background: 10 }
            },
            {
                coords: [77.2311, 28.7041],
                name: "Shahdara",
                district: "East Delhi",
                aqi: 295,
                pm25: 175.8,
                pm10: 295.2,
                no2: 50.5,
                category: "Hazardous",
                sources: { vehicular: 45, industrial: 30, biomass: 15, background: 10 }
            },
            {
                coords: [77.2773, 28.6304],
                name: "Mayur Vihar",
                district: "East Delhi",
                aqi: 270,
                pm25: 160.2,
                pm10: 270.5,
                no2: 46.9,
                category: "Very Unhealthy",
                sources: { vehicular: 50, industrial: 25, biomass: 15, background: 10 }
            },
            {
                coords: [77.3072, 28.5706],
                name: "Noida Sector 125",
                district: "Noida",
                aqi: 255,
                pm25: 150.3,
                pm10: 255.7,
                no2: 45.4,
                category: "Very Unhealthy",
                sources: { vehicular: 45, industrial: 30, biomass: 15, background: 10 }
            },
            {
                coords: [77.4538, 28.6692],
                name: "Ghaziabad",
                district: "Ghaziabad",
                aqi: 320,
                pm25: 190.5,
                pm10: 320.8,
                no2: 54.2,
                category: "Hazardous",
                sources: { vehicular: 40, industrial: 40, biomass: 10, background: 10 }
            }
        ];
        
        // Filter by district if specified
        let filteredStations = district === 'all' 
            ? allStations 
            : allStations.filter(s => s.district === district);
        
        // Convert to GeoJSON
        return {
            type: "FeatureCollection",
            features: filteredStations.map((station, idx) => ({
                type: "Feature",
                geometry: {
                    type: "Point",
                    coordinates: station.coords
                },
                properties: {
                    station_id: `DEL${String(idx + 1).padStart(3, '0')}`,
                    station_name: station.name,
                    district: station.district,
                    aqi: station.aqi,
                    pm25: station.pm25,
                    pm10: station.pm10,
                    no2: station.no2,
                    category: station.category,
                    timestamp: new Date().toISOString(),
                    source_vehicular: station.sources.vehicular,
                    source_industrial: station.sources.industrial,
                    source_biomass: station.sources.biomass,
                    source_background: station.sources.background,
                    forecast_1h: station.aqi + Math.floor(Math.random() * 20 - 10),
                    forecast_6h: station.aqi + Math.floor(Math.random() * 40 - 20),
                    forecast_24h: station.aqi + Math.floor(Math.random() * 60 - 30)
                }
            }))
        };
    },
    
    /**
     * Generate sample forecast data
     * @param {number} hour - Hour offset
     * @returns {Object} Sample forecast GeoJSON
     */
    getSampleForecastData(hour) {
        const currentData = this.getSampleCurrentData('all');
        
        // Modify AQI values based on hour (simulate diurnal variation)
        currentData.features.forEach(feature => {
            const baseAQI = feature.properties.aqi;
            // Peak pollution in morning (6-10) and evening (18-22)
            const hourFactor = Math.sin((hour - 6) * Math.PI / 12) * 0.3 + 1;
            const randomVariation = (Math.random() - 0.5) * 20;
            
            feature.properties.aqi = Math.round(baseAQI * hourFactor + randomVariation);
            feature.properties.pm25 = Math.round(feature.properties.pm25 * hourFactor + randomVariation * 0.5);
            feature.properties.pm10 = Math.round(feature.properties.pm10 * hourFactor + randomVariation * 0.8);
            feature.properties.category = getAQICategory(feature.properties.aqi);
        });
        
        return currentData;
    },
    
    /**
     * Generate sample grid data for heatmap
     * @returns {Object} Sample grid GeoJSON
     */
    getSampleGridData() {
        const features = [];
        
        // Delhi-NCR bounds (approximate)
        const minLon = 76.8;
        const maxLon = 77.6;
        const minLat = 28.4;
        const maxLat = 28.9;
        
        // 1km ‚âà 0.009 degrees at this latitude
        const resolution = 0.009;
        
        for (let lon = minLon; lon < maxLon; lon += resolution) {
            for (let lat = minLat; lat < maxLat; lat += resolution) {
                // Generate AQI with some spatial correlation
                // Higher pollution near center (Delhi)
                const distanceFromCenter = Math.sqrt(
                    Math.pow(lon - 77.2, 2) + Math.pow(lat - 28.6, 2)
                );
                
                const baseAQI = 150 + (0.3 - distanceFromCenter) * 200;
                const noise = (Math.random() - 0.5) * 80;
                const aqi = Math.max(50, Math.min(500, baseAQI + noise));
                
                features.push({
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [lon, lat]
                    },
                    properties: {
                        aqi: Math.round(aqi),
                        grid_id: `${lon.toFixed(3)}_${lat.toFixed(3)}`
                    }
                });
            }
        }
        
        return {
            type: "FeatureCollection",
            features: features
        };
    }
};
```

---

## STEP 4: Create Heatmap Layer

### 4.1 Create layers.js

Create `frontend/js/layers.js`:

```javascript
// Layer management for markers and heatmaps

const LayerManager = {
    /**
     * Create or update marker layer
     * @param {L.MarkerClusterGroup} markerLayer - Marker cluster group
     * @param {Object} data - GeoJSON feature collection
     */
    updateMarkerLayer(markerLayer, data) {
        // Clear existing markers
        markerLayer.clearLayers();
        
        // Add new markers
        data.features.forEach(feature => {
            const coords = feature.geometry.coordinates;
            const props = feature.properties;
            
            // Create circle marker
            const marker = L.circleMarker([coords[1], coords[0]], {
                radius: this.getMarkerRadius(props.aqi),
                fillColor: getAQIColor(props.aqi),
                color: '#ffffff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
            
            // Create popup content
            const popupContent = this.createPopupContent(props);
            marker.bindPopup(popupContent, {
                maxWidth: 350,
                className: 'custom-popup'
            });
            
            // Add marker to cluster group
            markerLayer.addLayer(marker);
        });
    },
    
    /**
     * Get marker radius based on AQI value
     * @param {number} aqi - AQI value
     * @returns {number} - Marker radius
     */
    getMarkerRadius(aqi) {
        // Larger markers for worse air quality
        if (aqi > 300) return 16;
        if (aqi > 200) return 14;
        if (aqi > 150) return 12;
        if (aqi > 100) return 10;
        return 8;
    },
    
    /**
     * Create popup HTML content
     * @param {Object} props - Feature properties
     * @returns {string} - HTML content
     */
    createPopupContent(props) {
        const aqiColor = getAQIColor(props.aqi);
        
        return `
            <div class="popup-header">
                <h3>${props.station_name}</h3>
                <div class="station-id">${props.station_id} ‚Ä¢ ${props.district}</div>
            </div>
            
            <div class="aqi-badge" style="background: ${aqiColor};">
                <span class="aqi-value">${props.aqi}</span>
                <span class="aqi-category">${props.category}</span>
            </div>
            
            <div class="popup-data">
                <div class="data-row">
                    <span class="data-label">PM2.5:</span>
                    <span class="data-value">${props.pm25.toFixed(1)} Œºg/m¬≥</span>
                </div>
                <div class="data-row">
                    <span class="data-label">PM10:</span>
                    <span class="data-value">${props.pm10.toFixed(1)} Œºg/m¬≥</span>
                </div>
                ${props.no2 ? `
                    <div class="data-row">
                        <span class="data-label">NO‚ÇÇ:</span>
                        <span class="data-value">${props.no2.toFixed(1)} ppb</span>
                    </div>
                ` : ''}
            </div>
            
            <div class="forecast-section">
                <h4>Forecasts</h4>
                <div class="data-row">
                    <span class="data-label">+1 hour:</span>
                    <span class="data-value">${props.forecast_1h}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">+6 hours:</span>
                    <span class="data-value">${props.forecast_6h}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">+24 hours:</span>
                    <span class="data-value">${props.forecast_24h}</span>
                </div>
            </div>
            
            ${this.createSourceAttribution(props)}
            
            <div class="timestamp">
                Updated: ${formatTimestamp(props.timestamp)}
            </div>
        `;
    },
    
    /**
     * Create source attribution visualization
     * @param {Object} props - Feature properties
     * @returns {string} - HTML for source attribution
     */
    createSourceAttribution(props) {
        return `
            <div class="source-attribution">
                <h4>Source Attribution</h4>
                <div class="source-bar">
                    <div class="source-segment" 
                         style="width: ${props.source_vehicular}%; background: #e74c3c;"></div>
                    <div class="source-segment" 
                         style="width: ${props.source_industrial}%; background: #f39c12;"></div>
                    <div class="source-segment" 
                         style="width: ${props.source_biomass}%; background: #27ae60;"></div>
                    <div class="source-segment" 
                         style="width: ${props.source_background}%; background: #95a5a6;"></div>
                </div>
                <div class="source-legend">
                    <div class="source-item">
                        <div class="source-color" style="background: #e74c3c;"></div>
                        <span>üöó Vehicular: ${props.source_vehicular}%</span>
                    </div>
                    <div class="source-item">
                        <div class="source-color" style="background: #f39c12;"></div>
                        <span>üè≠ Industrial: ${props.source_industrial}%</span>
                    </div>
                    <div class="source-item">
                        <div class="source-color" style="background: #27ae60;"></div>
                        <span>üî• Biomass: ${props.source_biomass}%</span>
                    </div>
                    <div class="source-item">
                        <div class="source-color" style="background: #95a5a6;"></div>
                        <span>üå´Ô∏è Background: ${props.source_background}%</span>
                    </div>
                </div>
            </div>
        `;
    },
    
    /**
     * Create heatmap layer
     * @param {Object} data - GeoJSON feature collection
     * @returns {L.HeatLayer} - Heatmap layer
     */
    createHeatmapLayer(data) {
        // Convert features to heatmap format [lat, lng, intensity]
        const heatData = data.features.map(feature => {
            const coords = feature.geometry.coordinates;
            const aqi = feature.properties.aqi;
            
            return [
                coords[1],  // latitude
                coords[0],  // longitude
                aqi / 500   // normalize to 0-1
            ];
        });
        
        // Create heatmap layer with custom gradient
        return L.heatLayer(heatData, {
            radius: 30,
            blur: 20,
            maxZoom: 14,
            max: 1.0,
            gradient: {
                0.0: '#00E400',   // Good
                0.1: '#FFFF00',   // Moderate
                0.3: '#FF7E00',   // Unhealthy for Sensitive
                0.4: '#FF0000',   // Unhealthy
                0.6: '#8F3F97',   // Very Unhealthy
                1.0: '#7E0023'    // Hazardous
            }
        });
    }
};
```

---

## STEP 5-10 Continue...

Due to length constraints, I've provided the first 4 critical steps. Would you like me to continue with:

- **Step 5**: Add Interactive Features (search, filtering)
- **Step 6**: Implement 24-Hour Forecast Animation
- **Step 7**: Add Source Attribution Visualization
- **Step 8**: Connect to Backend API (Python FastAPI example)
- **Step 9**: Mobile Optimization
- **Step 10**: Testing & Deployment

Let me know if you want me to continue with the remaining steps!
