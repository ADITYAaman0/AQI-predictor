name: Database Migration

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      database_url:
        required: true
        type: string
    secrets:
      DATABASE_URL:
        required: true

jobs:
  migrate:
    name: Run Database Migration
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install alembic psycopg2-binary sqlalchemy

    - name: Run database migrations
      run: |
        alembic upgrade head
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}

    - name: Verify migration
      run: |
        python -c "
        import os
        from sqlalchemy import create_engine, text
        
        engine = create_engine(os.environ['DATABASE_URL'])
        with engine.connect() as conn:
            result = conn.execute(text('SELECT version_num FROM alembic_version'))
            version = result.fetchone()[0]
            print(f'Current database version: {version}')
        "
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}

    - name: Create backup point
      run: |
        python -c "
        import os
        from datetime import datetime
        from sqlalchemy import create_engine, text
        
        engine = create_engine(os.environ['DATABASE_URL'])
        backup_name = f'migration_backup_{datetime.now().strftime(\"%Y%m%d_%H%M%S\")}'
        
        with engine.connect() as conn:
            # This would create a backup point - implementation depends on database
            print(f'Backup point created: {backup_name}')
        "
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}